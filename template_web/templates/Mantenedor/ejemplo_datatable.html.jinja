{#
  EXAMPLE USAGE: DataTable with Server-Side Processing

  This template demonstrates how to use datatable_base.html.jinja to create
  a table with server-side processing.
#}

{% extends "Shared/datatable_base.html.jinja" %}

{# Page Configuration #}
{% block page_title %}DataTable Example{% endblock %}
{% block create_button_text %}Create Record{% endblock %}
{% block create_button_id %}btnCreate{% endblock %}

{# JavaScript code to initialize the DataTable #}
{% block datatable_js %}
<script>
  // Endpoint URLs
  const urlGetData = "/api/ejemplo/datos";
  const urlCreateEdit = "/api/ejemplo/update";

  $(document).ready(function () {
    loadTable();

    // Event for create button
    $("#btnCreate").click(function () {
      showCreateEditModal({});
    });
  });

  /**
   * Initialize the table with server-side processing
   */
  function loadTable() {
    // Use the InicializarTablaServerSide helper from datatable-serverside.js file
    InicializarTablaServerSide("#tabla", {
      url: urlGetData,
      responsive: ObtenerConfigResponsiveDataTable(),
      columns: [
        {
          data: "id",
          title: "ID",
          name: "id",
          className: "text-center"
        },
        {
          data: "nombre",
          title: "Name",
          name: "nombre"
        },
        {
          data: "email",
          title: "Email",
          name: "email"
        },
        {
          data: "activo",
          title: "Status",
          className: "text-center",
          name: "activo",
          render: (data) => RenderizarEstado(data)
        },
        {
          data: null,
          title: "Actions",
          className: "text-center",
          name: "acciones",
          orderable: false,
          searchable: false,
          render: function (data, type, row) {
            return (
              RenderizarBotonEditar("showCreateEditModal", row) +
              RenderizarBotonToggle("toggleActivate", row, row.activo)
            );
          }
        }
      ],
      defaultOrder: [[0, 'desc']], // ID descending by default
      pageLength: 25,
      onError: function (jqXHR, textStatus, errorThrown) {
        console.error('Error loading data:', textStatus, errorThrown);
        MostrarError('Error loading data', 'An error occurred while retrieving information.');
      }
    });
  }

  /**
   * Show modal to create/edit a record
   */
  function showCreateEditModal(row) {
    const isEditMode = !!row.id;
    const titleText = isEditMode ? `Edit: ${row.nombre}` : "Create New Record";

    Swal.fire({
      title: titleText,
      html: `
        <div class="row mx-0 mb-0 mt-1">
          <div class="col-12 mb-3">
            <div class="input-group">
              <div class="input-group-prepend">
                <label class="input-group-text" for="nombre">Name</label>
              </div>
              <input type="text" id="nombre" class="form-control"
                value="${row.nombre || ''}" placeholder="Name">
              <div id="nombre_error" class="invalid-feedback"></div>
            </div>
          </div>
          <div class="col-12 mb-3">
            <div class="input-group">
              <div class="input-group-prepend">
                <label class="input-group-text" for="email">Email</label>
              </div>
              <input type="email" id="email" class="form-control"
                value="${row.email || ''}" placeholder="Email">
              <div id="email_error" class="invalid-feedback"></div>
            </div>
          </div>
          <div class="col mb-3 d-flex">
            <div class="input-group-prepend">
              <label class="input-group-text" for="activo">Active</label>
            </div>
            <div class="form-control d-flex align-items-center justify-content-center"
              style="margin-left: -2px;">
              <label class="switch">
                <input type="checkbox" id="activo" ${row.activo ? "checked" : ""}>
                <span class="slider round"></span>
              </label>
            </div>
          </div>
        </div>
      `,
      focusConfirm: false,
      showCancelButton: true,
      customClass: ObtenerSwalClasses(),
      confirmButtonText: "Confirm",
      cancelButtonText: "Cancel",
      reverseButtons: true,
      preConfirm: async () => {
        // Validate fields
        const fieldsToValidate = ["nombre", "email"];
        let allFieldsValid = true;

        for (const field of fieldsToValidate) {
          const element = document.getElementById(field);
          const errorElement = document.getElementById(`${field}_error`);
          const isValid = await ValidarCampoGenerico(element, errorElement, {
            tipo: field === "email" ? "email" : null
          });
          if (!isValid) {
            allFieldsValid = false;
          }
          if (element) {
            row[field] = element.value.trim();
          }
        }

        row.activo = document.getElementById("activo").checked;

        if (!allFieldsValid) {
          Swal.showValidationMessage("Please correct the errors before continuing.");
          return false;
        }

        return row;
      }
    }).then((result) => {
      if (result.isConfirmed) {
        saveRecord(result.value);
      }
    });
  }

  /**
   * Save a record (create or edit)
   */
  function saveRecord(data) {
    $.ajax({
      url: urlCreateEdit,
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify(data),
      success: function (response) {
        MostrarExitoTemporal("Operation completed successfully");
        // With server-side processing, simply reload the table
        RecargarTablaServerSide("#tabla");
      },
      error: function (jqXHR) {
        const errorMessage = ExtraerMensajeError(jqXHR);
        MostrarError("An error occurred in the process", errorMessage);
      }
    });
  }

  /**
   * Activate/Deactivate a record
   */
  function toggleActivate(row) {
    const action = row.activo ? "deactivate" : "activate";

    MostrarConfirmacion(
      `Are you sure you want to ${action}?`,
      `This action will ${action} the record.`,
      `Yes, ${action}`
    ).then((result) => {
      if (result.isConfirmed) {
        row.activo = !row.activo;
        saveRecord(row);
      }
    });
  }
</script>
{% endblock %}
