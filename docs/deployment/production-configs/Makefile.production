# ============================================================================
# Makefile - Docker Production Commands
# ============================================================================
#
# Comandos Ãºtiles para gestionar el entorno Docker en producciÃ³n.
#
# Uso:
#   make help           - Ver todos los comandos disponibles
#   make build          - Build de todas las imÃ¡genes
#   make up             - Iniciar todos los servicios
#   make down           - Detener todos los servicios
#
# ============================================================================

.PHONY: help
.DEFAULT_GOAL := help

# Variables
COMPOSE_FILE := docker-compose.production.yml
PROJECT_NAME := myproject

# Colores para output
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
NC := \033[0m # No Color

## ============================================================================
## COMANDOS PRINCIPALES
## ============================================================================

.PHONY: help
help: ## Mostrar esta ayuda
	@echo ""
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "$(BLUE)   Makefile - Docker Production Commands$(NC)"
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@awk 'BEGIN {FS = ":.*##"; printf "Uso: make $(GREEN)<comando>$(NC)\n\n"} /^[a-zA-Z_-]+:.*?##/ { printf "  $(GREEN)%-20s$(NC) %s\n", $$1, $$2 } /^##@/ { printf "\n$(YELLOW)%s$(NC)\n", substr($$0, 5) } ' $(MAKEFILE_LIST)
	@echo ""

##@ ğŸ—ï¸  Build

.PHONY: build build-api build-web build-worker build-no-cache

build: ## Build todas las imÃ¡genes
	@echo "$(BLUE)Building all images...$(NC)"
	docker-compose -f $(COMPOSE_FILE) build
	@echo "$(GREEN)âœ“ Build completado$(NC)"

build-api: ## Build solo imagen de API
	@echo "$(BLUE)Building API image...$(NC)"
	docker-compose -f $(COMPOSE_FILE) build api
	@echo "$(GREEN)âœ“ API build completado$(NC)"

build-web: ## Build solo imagen de Web
	@echo "$(BLUE)Building Web image...$(NC)"
	docker-compose -f $(COMPOSE_FILE) build web
	@echo "$(GREEN)âœ“ Web build completado$(NC)"

build-worker: ## Build solo imagen de Worker
	@echo "$(BLUE)Building Worker image...$(NC)"
	docker-compose -f $(COMPOSE_FILE) build worker
	@echo "$(GREEN)âœ“ Worker build completado$(NC)"

build-no-cache: ## Build sin cache (limpio)
	@echo "$(BLUE)Building all images without cache...$(NC)"
	docker-compose -f $(COMPOSE_FILE) build --no-cache
	@echo "$(GREEN)âœ“ Build completado$(NC)"

##@ ğŸš€ Deployment

.PHONY: up down restart stop start

up: ## Iniciar todos los servicios
	@echo "$(BLUE)Starting all services...$(NC)"
	docker-compose -f $(COMPOSE_FILE) up -d
	@echo "$(GREEN)âœ“ Servicios iniciados$(NC)"
	@$(MAKE) ps

down: ## Detener todos los servicios
	@echo "$(BLUE)Stopping all services...$(NC)"
	docker-compose -f $(COMPOSE_FILE) down
	@echo "$(GREEN)âœ“ Servicios detenidos$(NC)"

restart: ## Reiniciar todos los servicios
	@echo "$(BLUE)Restarting all services...$(NC)"
	docker-compose -f $(COMPOSE_FILE) restart
	@echo "$(GREEN)âœ“ Servicios reiniciados$(NC)"

stop: ## Detener servicios (sin eliminar contenedores)
	@echo "$(BLUE)Stopping services...$(NC)"
	docker-compose -f $(COMPOSE_FILE) stop
	@echo "$(GREEN)âœ“ Servicios detenidos$(NC)"

start: ## Iniciar servicios detenidos
	@echo "$(BLUE)Starting stopped services...$(NC)"
	docker-compose -f $(COMPOSE_FILE) start
	@echo "$(GREEN)âœ“ Servicios iniciados$(NC)"

##@ ğŸ”„ Updates

.PHONY: update deploy rollback

update: ## Actualizar servicios (pull + build + deploy)
	@echo "$(BLUE)Updating services...$(NC)"
	git pull
	docker-compose -f $(COMPOSE_FILE) build
	docker-compose -f $(COMPOSE_FILE) up -d --no-deps --build
	@echo "$(GREEN)âœ“ Servicios actualizados$(NC)"

deploy: build up ## Build + Deploy (full deployment)
	@echo "$(GREEN)âœ“ Deployment completado$(NC)"
	@$(MAKE) health

rollback: ## Rollback a imagen anterior
	@echo "$(YELLOW)âš  Implementar lÃ³gica de rollback$(NC)"

##@ ğŸ“Š Monitoring

.PHONY: ps logs logs-api logs-web logs-worker health stats

ps: ## Ver estado de servicios
	@docker-compose -f $(COMPOSE_FILE) ps

logs: ## Ver logs de todos los servicios
	docker-compose -f $(COMPOSE_FILE) logs -f

logs-api: ## Ver logs de API
	docker-compose -f $(COMPOSE_FILE) logs -f api

logs-web: ## Ver logs de Web
	docker-compose -f $(COMPOSE_FILE) logs -f web

logs-worker: ## Ver logs de Worker
	docker-compose -f $(COMPOSE_FILE) logs -f worker

logs-nginx: ## Ver logs de Nginx
	docker-compose -f $(COMPOSE_FILE) logs -f nginx

logs-postgres: ## Ver logs de PostgreSQL
	docker-compose -f $(COMPOSE_FILE) logs -f postgres

health: ## Verificar health de servicios
	@echo "$(BLUE)Checking service health...$(NC)"
	@echo ""
	@curl -s http://localhost/health | jq . || echo "$(RED)âœ— Health check failed$(NC)"
	@echo ""
	@docker-compose -f $(COMPOSE_FILE) ps

stats: ## Ver estadÃ­sticas de recursos
	docker stats --no-stream

##@ ğŸ”§ Maintenance

.PHONY: shell-api shell-web shell-worker shell-postgres exec-api exec-web exec-worker

shell-api: ## Abrir shell en contenedor API
	docker-compose -f $(COMPOSE_FILE) exec api /bin/bash

shell-web: ## Abrir shell en contenedor Web
	docker-compose -f $(COMPOSE_FILE) exec web /bin/bash

shell-worker: ## Abrir shell en contenedor Worker
	docker-compose -f $(COMPOSE_FILE) exec worker /bin/bash

shell-postgres: ## Abrir psql en PostgreSQL
	docker-compose -f $(COMPOSE_FILE) exec postgres psql -U $$(grep DB_USER .env | cut -d '=' -f2) -d $$(grep DB_NAME .env | cut -d '=' -f2)

exec-api: ## Ejecutar comando en API (uso: make exec-api CMD="ls -la")
	docker-compose -f $(COMPOSE_FILE) exec api $(CMD)

exec-web: ## Ejecutar comando en Web (uso: make exec-web CMD="ls -la")
	docker-compose -f $(COMPOSE_FILE) exec web $(CMD)

exec-worker: ## Ejecutar comando en Worker (uso: make exec-worker CMD="ls -la")
	docker-compose -f $(COMPOSE_FILE) exec worker $(CMD)

##@ ğŸ’¾ Backup & Restore

.PHONY: backup backup-db backup-volumes restore-db list-backups

backup: backup-db backup-volumes ## Backup completo (DB + volÃºmenes)

backup-db: ## Backup de base de datos
	@echo "$(BLUE)Backing up database...$(NC)"
	@mkdir -p backups
	@docker-compose -f $(COMPOSE_FILE) exec -T postgres pg_dump -U $$(grep DB_USER .env | cut -d '=' -f2) $$(grep DB_NAME .env | cut -d '=' -f2) | gzip > backups/db_backup_$$(date +%Y%m%d_%H%M%S).sql.gz
	@echo "$(GREEN)âœ“ Database backup created$(NC)"

backup-volumes: ## Backup de volÃºmenes
	@echo "$(BLUE)Backing up volumes...$(NC)"
	@mkdir -p backups
	@docker run --rm -v $(PROJECT_NAME)_postgres_data:/data -v $$(pwd)/backups:/backup alpine tar czf /backup/postgres_data_$$(date +%Y%m%d_%H%M%S).tar.gz -C /data .
	@docker run --rm -v $(PROJECT_NAME)_redis_data:/data -v $$(pwd)/backups:/backup alpine tar czf /backup/redis_data_$$(date +%Y%m%d_%H%M%S).tar.gz -C /data .
	@echo "$(GREEN)âœ“ Volumes backup created$(NC)"

restore-db: ## Restaurar base de datos (uso: make restore-db FILE=backups/db_backup.sql.gz)
	@echo "$(BLUE)Restoring database from $(FILE)...$(NC)"
	@gunzip -c $(FILE) | docker-compose -f $(COMPOSE_FILE) exec -T postgres psql -U $$(grep DB_USER .env | cut -d '=' -f2) -d $$(grep DB_NAME .env | cut -d '=' -f2)
	@echo "$(GREEN)âœ“ Database restored$(NC)"

list-backups: ## Listar backups disponibles
	@echo "$(BLUE)Available backups:$(NC)"
	@ls -lh backups/

##@ ğŸ§¹ Cleanup

.PHONY: clean clean-images clean-volumes clean-all prune

clean: ## Limpiar contenedores detenidos
	@echo "$(BLUE)Cleaning stopped containers...$(NC)"
	docker-compose -f $(COMPOSE_FILE) down --remove-orphans
	@echo "$(GREEN)âœ“ Cleanup completado$(NC)"

clean-images: ## Eliminar imÃ¡genes sin usar
	@echo "$(BLUE)Cleaning unused images...$(NC)"
	docker image prune -f
	@echo "$(GREEN)âœ“ Images cleaned$(NC)"

clean-volumes: ## Eliminar volÃºmenes (âš ï¸ DESTRUYE DATOS)
	@echo "$(RED)âš ï¸  WARNING: This will delete all volumes and data!$(NC)"
	@read -p "Are you sure? [y/N] " -n 1 -r; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		echo ""; \
		docker-compose -f $(COMPOSE_FILE) down -v; \
		echo "$(GREEN)âœ“ Volumes deleted$(NC)"; \
	else \
		echo ""; \
		echo "$(YELLOW)Cancelled$(NC)"; \
	fi

clean-all: ## Limpieza completa del sistema Docker
	@echo "$(BLUE)Full Docker cleanup...$(NC)"
	docker system prune -a --volumes -f
	@echo "$(GREEN)âœ“ Full cleanup completado$(NC)"

prune: ## Limpieza rÃ¡pida (containers, networks, images)
	@echo "$(BLUE)Pruning Docker system...$(NC)"
	docker system prune -f
	@echo "$(GREEN)âœ“ Prune completado$(NC)"

##@ ğŸ” Security

.PHONY: scan-api scan-web scan-worker generate-secrets

scan-api: ## Escanear vulnerabilidades en imagen API
	@echo "$(BLUE)Scanning API image for vulnerabilities...$(NC)"
	docker scan $(PROJECT_NAME)_api:latest || echo "$(YELLOW)Docker scan not available$(NC)"

scan-web: ## Escanear vulnerabilidades en imagen Web
	@echo "$(BLUE)Scanning Web image for vulnerabilities...$(NC)"
	docker scan $(PROJECT_NAME)_web:latest || echo "$(YELLOW)Docker scan not available$(NC)"

scan-worker: ## Escanear vulnerabilidades en imagen Worker
	@echo "$(BLUE)Scanning Worker image for vulnerabilities...$(NC)"
	docker scan $(PROJECT_NAME)_worker:latest || echo "$(YELLOW)Docker scan not available$(NC)"

generate-secrets: ## Generar nuevos secrets
	@echo "$(BLUE)Generating new secrets...$(NC)"
	@echo ""
	@echo "SECRET_KEY=$$(openssl rand -base64 32)"
	@echo "JWT_SECRET_KEY=$$(openssl rand -base64 32)"
	@echo "REDIS_PASSWORD=$$(openssl rand -base64 16)"
	@echo ""
	@echo "$(YELLOW)âš  Agregar estos valores a .env manualmente$(NC)"

##@ ğŸ“ˆ Scale

.PHONY: scale-api scale-web scale-worker

scale-api: ## Escalar API (uso: make scale-api N=3)
	@echo "$(BLUE)Scaling API to $(N) instances...$(NC)"
	docker-compose -f $(COMPOSE_FILE) up -d --scale api=$(N)
	@echo "$(GREEN)âœ“ API scaled to $(N) instances$(NC)"

scale-web: ## Escalar Web (uso: make scale-web N=2)
	@echo "$(BLUE)Scaling Web to $(N) instances...$(NC)"
	docker-compose -f $(COMPOSE_FILE) up -d --scale web=$(N)
	@echo "$(GREEN)âœ“ Web scaled to $(N) instances$(NC)"

scale-worker: ## Escalar Worker (uso: make scale-worker N=2)
	@echo "$(BLUE)Scaling Worker to $(N) instances...$(NC)"
	docker-compose -f $(COMPOSE_FILE) up -d --scale worker=$(N)
	@echo "$(GREEN)âœ“ Worker scaled to $(N) instances$(NC)"

##@ ğŸ§ª Testing

.PHONY: test test-api test-web test-integration

test: ## Ejecutar todos los tests
	@echo "$(BLUE)Running all tests...$(NC)"
	docker-compose -f $(COMPOSE_FILE) exec api pytest tests/
	@echo "$(GREEN)âœ“ Tests completados$(NC)"

test-api: ## Ejecutar tests de API
	docker-compose -f $(COMPOSE_FILE) exec api pytest tests/ -v

test-web: ## Ejecutar tests de Web
	docker-compose -f $(COMPOSE_FILE) exec web pytest tests/ -v

test-integration: ## Ejecutar tests de integraciÃ³n
	docker-compose -f $(COMPOSE_FILE) exec api pytest tests/integration/ -v

##@ ğŸ“ Info

.PHONY: config validate inspect-api inspect-web version

config: ## Ver configuraciÃ³n de docker-compose
	docker-compose -f $(COMPOSE_FILE) config

validate: ## Validar configuraciÃ³n
	@echo "$(BLUE)Validating configuration...$(NC)"
	@docker-compose -f $(COMPOSE_FILE) config > /dev/null && echo "$(GREEN)âœ“ Configuration is valid$(NC)" || echo "$(RED)âœ— Configuration has errors$(NC)"

inspect-api: ## Inspeccionar contenedor API
	docker inspect $(PROJECT_NAME)_api

inspect-web: ## Inspeccionar contenedor Web
	docker inspect $(PROJECT_NAME)_web

version: ## Ver versiones de Docker y Compose
	@echo "$(BLUE)Docker version:$(NC)"
	@docker --version
	@echo ""
	@echo "$(BLUE)Docker Compose version:$(NC)"
	@docker-compose --version
	@echo ""

##@ ğŸ¯ Quick Commands

.PHONY: dev prod status restart-api restart-web restart-worker

dev: ## Modo desarrollo (hot-reload)
	@echo "$(YELLOW)Para desarrollo, usar docker-compose.yml normal$(NC)"

prod: build up ## Deploy rÃ¡pido a producciÃ³n
	@echo "$(GREEN)âœ“ Production deployment completado$(NC)"

status: ps health ## Estado completo del sistema

restart-api: ## Reiniciar solo API
	docker-compose -f $(COMPOSE_FILE) restart api
	@echo "$(GREEN)âœ“ API restarted$(NC)"

restart-web: ## Reiniciar solo Web
	docker-compose -f $(COMPOSE_FILE) restart web
	@echo "$(GREEN)âœ“ Web restarted$(NC)"

restart-worker: ## Reiniciar solo Worker
	docker-compose -f $(COMPOSE_FILE) restart worker
	@echo "$(GREEN)âœ“ Worker restarted$(NC)"

restart-nginx: ## Reiniciar Nginx
	docker-compose -f $(COMPOSE_FILE) restart nginx
	@echo "$(GREEN)âœ“ Nginx restarted$(NC)"

##@ âš¡ Shortcuts

.PHONY: b u d l

b: build ## Alias para build
u: up ## Alias para up
d: down ## Alias para down
l: logs ## Alias para logs
